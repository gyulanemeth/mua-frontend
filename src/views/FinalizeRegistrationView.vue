<script setup>
import { watchEffect, ref } from 'vue'
import { useRoute } from 'vue-router'
import jwtDecode from 'jwt-decode'
import { useI18n } from 'vue-i18n'

import AcceptInvitationForm from '../components/AcceptInvitationForm.vue'

import { useCurrentUserAndAccountStore } from '../stores/index.js'
import useSystemMessagesStore from '../stores/systemMessages.js'

const { tm } = useI18n()
const store = useCurrentUserAndAccountStore()
const route = useRoute()

const data = ref()
const formData = ref()

async function loadData () {
  if (route.name === 'system-accounts-accept-invitation' && route.query.token) {
    data.value = jwtDecode(route.query.token)
    formData.value = {
      btnText: tm('acceptInvitationForm.btnText'),
      header: tm('acceptInvitationForm.header')
    }
  }
  if (route.name === 'system-accounts-finalize-registration' && route.query.token) {
    const res = await store.finalizeRegistration(route.query.token)
    if (res.success) {
      useSystemMessagesStore().addSuccess({ message: tm('FinalizeRegistrationView.FinalizeRegistrationAlert') })
    }
  }
}

async function handleAcceptInvitationEvent (params, statusCallBack) {
  await new Promise(resolve => setTimeout(resolve, 5000))
  await store.acceptInvitation(route.query.token, params.newPassword, params.newPasswordAgain, params.name)
  statusCallBack()
}

watchEffect(async () => {
  loadData()
})

</script>

<template>

<AcceptInvitationForm v-if="formData" :formData="formData" @handleAcceptInvitationHandler="handleAcceptInvitationEvent" />

</template>
